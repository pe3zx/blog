<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Problems in CVE-2020-0796 Scanner Scripts ::
        Pandora&#39;s Box
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="ทางเลือกในการตรวจสอบที่ได้ผลจริงๆ มีเพียงสองกรณี คือการตรวจสอบแพตช์ด้วยโซลูชันต่างๆ และการตรวจสอบโดยการทดสอบโจมตีจริง วิธีการการตรวจสอบโดยใช้สคริปต์ Scanner ไม่สามารถช่วยยืนยันได้ว่าระบบมีช่องโหว่จริงหรือไม่
 หลังการหลุดออกมาของรายละเอียดของช่องโหว่ในฟังก์ชันซึ่งมีการใช้โปรโตคอล SMB รวมไปถึงคุณลักษณะที่ช่องโหว่นั้น Wormable ได้ เราเห็นความตื่นตัวที่เพิ่มขึ้นมาอย่างฉับพลันและสะท้อนให้เห็นถึงการเรียนรู้จากการแพร่กระจายของ WannaCry ซึ่งโจมตีช่องโหว่ CVE-2017-0143 และ CVE-2017-0144 ด้วย ETERNALBLUE หนึ่งในความตื่นตัวนั้นคือการปรากฎออกมาถึงวิธีการในใช้เพื่อยืนยันการมีอยู่ของช่องโหว่ในระบบต่างๆ ในรูปแบบของสคริปต์ที่สามารถทำงานได้จากการระบุเพียงแค่หมายเลขไอพีแอดเดรสที่ต้องการตรวจสอบไปอย่างเดียว
อย่างไรก็ตามเนื่องจากที่มีของช่องโหว่นี้นั้นมาจากการ &amp;ldquo;หลุด&amp;rdquo; และยังเห็นได้ถึงความพยายามในการปิดข่าวก่อนที่ทางไมโครซอฟต์จะพร้อมปล่อยแพตช์จริงๆ ในช่วงนั้นเราอาจพูดได้ว่าแทบไม่มีใครที่ทราบอย่างแท้จริงถึงรายละเอียดและที่มาของช่องโหว่นั้นนอกเสียจากเป็นบุคคลกลุ่มที่หนึ่งและที่สองซึ่งเกี่ยวข้องกับการป้องกันและลดผลกระทบจากการโจมตีช่องโหว่นี้เองที่ควรจะทราบข้อมูลดีที่สุด
ด้วยเหตุนี้เราอาจถือได้ว่าผลผลิตใดๆ ที่เกิดในช่วงเวลาที่ข้อมูลยังไม่ชัดเจนนั้นสามารถที่จะสร้างผลลัพธ์ที่ไม่ชัดเจนได้ตามข้อมูลที่มันนำมาประเมิน และนี่คือประเด็นหลักที่เราจะพูดถึงกันในบล็อกนี้ครับ
การเกิดขึ้นของสคริปต์ Scanner ในช่วงก่อนมีการออกแพตช์และเปิดเผยรายละเอียดของช่องโหว่อย่างชัดเจน มีการปรากฎของสคริปต์ที่อ้างว่าสามารถยืนยันการมีอยู่ของช่องโหว่ได้เป็นจำนวนมาก บางส่วนที่เราพบมีตามรายการดังนี้
 สคริปต์จาก ollypwn/SMBGHost สคริปต์จาก xax007/CVE-2020-0796-Scanner  เมื่อเราใช้สคริปต์ในการตรวจหาการมีอยู่ของช่องโหว่ในมุมของผู้ใช้งาน เราคาดหวังว่าผลลัพธ์ของสคริปต์จะต้องสามารถบอกได้ว่าระบบที่เราตรวจสอบนั้นมีช่องโหว่ (Vulnerable) หรือไม่มีช่องโหว่ (Not Vulnerable) และที่สำคัญกว่านั้นความน่าเชื่อถือของผลลัพธ์ที่มาจากการใช้สคริปต์เหล่านี้ซึ่งจะส่งผลต้องกระบวนการ Vulnerability management อย่างชัดเจน ดังนั้นการจะยืนยันความน่าเชื่อถือของผลลัพธ์จากสคริปต์เหล่านี้ได้นั้นคือเข้าใจวิธีการในการตรวจหาและเงื่อนไขที่ทำให้สคริปต์ระบุว่าระบบนั้นๆ มีช่องโหว่
เงื่อนไขของ ollypwn/SMBGhost ในการระบุหาช่องโหว่ สำหรับสคริปต์ ollypwn/SMBGhost นั้น มันถูกพัฒนาขึ้นมาจากการทำงานของโปรโตคอลจริงๆ ตามที่ปรากฎไว้ในไฟล์ SmbGhost.pcap ตามรูปภาพด้านล่าง
pkt = b&amp;#39;\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02&amp;#34;\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&amp;amp;\x00\x00\x00\x00\x00\x01\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00&amp;#39; subnet = sys.argv[1] for ip in IPNetwork(subnet): sock = socket."
/>
<meta
  name="keywords"
  content="Blog by P. Boonyakarn"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://pandora.sh/posts/cve-2020-0796-scanner-scripts-issues/" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<link rel="stylesheet" href="https://pandora.sh/assets/style.css" />

<link rel="stylesheet" href="https://pandora.sh/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://pandora.sh/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://pandora.sh/img/favicon.png" />


<link href="https://pandora.sh/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://pandora.sh/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://pandora.sh/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://pandora.sh/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://pandora.sh/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://pandora.sh/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Problems in CVE-2020-0796 Scanner Scripts"/>
<meta name="twitter:description" content="หลังการหลุดออกมาของรายละเอียดของช่องโหว่ในฟังก์ชันซึ่งมีการใช้โปรโตคอล SMB รวมไปถึงคุณลักษณะที่ช่องโหว่นั้น Wormable ได้ เราเห็นความตื่นตัวที่เพิ่มขึ้นมาอย่างฉับพลันและสะท้อนให้เห็นถึงการเรียนรู้จากการแพร่กระจายของ WannaCry ซึ่งโจมตีช่องโหว่ CVE-2017-0143 และ CVE-2017-0144 ด้วย ETERNALBLUE หนึ่งในความตื่นตัวนั้นคือการปรากฎออกมาถึงวิธีการในใช้เพื่อยืนยันการมีอยู่ของช่องโหว่ในระบบต่างๆ ในรูปแบบของสคริปต์ที่สามารถทำงานได้จากการระบุเพียงแค่หมายเลขไอพีแอดเดรสที่ต้องการตรวจสอบไปอย่างเดียว"/>



<meta property="og:title" content="Problems in CVE-2020-0796 Scanner Scripts" />
<meta property="og:description" content="หลังการหลุดออกมาของรายละเอียดของช่องโหว่ในฟังก์ชันซึ่งมีการใช้โปรโตคอล SMB รวมไปถึงคุณลักษณะที่ช่องโหว่นั้น Wormable ได้ เราเห็นความตื่นตัวที่เพิ่มขึ้นมาอย่างฉับพลันและสะท้อนให้เห็นถึงการเรียนรู้จากการแพร่กระจายของ WannaCry ซึ่งโจมตีช่องโหว่ CVE-2017-0143 และ CVE-2017-0144 ด้วย ETERNALBLUE หนึ่งในความตื่นตัวนั้นคือการปรากฎออกมาถึงวิธีการในใช้เพื่อยืนยันการมีอยู่ของช่องโหว่ในระบบต่างๆ ในรูปแบบของสคริปต์ที่สามารถทำงานได้จากการระบุเพียงแค่หมายเลขไอพีแอดเดรสที่ต้องการตรวจสอบไปอย่างเดียว" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pandora.sh/posts/cve-2020-0796-scanner-scripts-issues/" />
<meta property="article:published_time" content="2020-04-04T15:49:17+07:00" />
<meta property="article:modified_time" content="2020-04-04T15:49:17+07:00" /><meta property="og:site_name" content="Pandora&#39;s Box" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >PANDORA&#39;S BOX</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Problems in CVE-2020-0796 Scanner Scripts</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-04-04
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by P. Boonyakarn</span
        >


      
    </div>

    

    

    <div class="post-content">
      
      <blockquote>
<p>ทางเลือกในการตรวจสอบที่ได้ผลจริงๆ มีเพียงสองกรณี คือการตรวจสอบแพตช์ด้วยโซลูชันต่างๆ และการตรวจสอบโดยการทดสอบโจมตีจริง วิธีการการตรวจสอบโดยใช้สคริปต์ Scanner ไม่สามารถช่วยยืนยันได้ว่าระบบมีช่องโหว่จริงหรือไม่</p>
</blockquote>
<p>หลังการหลุดออกมาของรายละเอียดของช่องโหว่ในฟังก์ชันซึ่งมีการใช้โปรโตคอล SMB รวมไปถึงคุณลักษณะที่ช่องโหว่นั้น Wormable ได้ เราเห็นความตื่นตัวที่เพิ่มขึ้นมาอย่างฉับพลันและสะท้อนให้เห็นถึงการเรียนรู้จากการแพร่กระจายของ WannaCry ซึ่งโจมตีช่องโหว่ CVE-2017-0143 และ CVE-2017-0144 ด้วย ETERNALBLUE หนึ่งในความตื่นตัวนั้นคือการปรากฎออกมาถึงวิธีการในใช้เพื่อยืนยันการมีอยู่ของช่องโหว่ในระบบต่างๆ ในรูปแบบของสคริปต์ที่สามารถทำงานได้จากการระบุเพียงแค่หมายเลขไอพีแอดเดรสที่ต้องการตรวจสอบไปอย่างเดียว</p>
<p>อย่างไรก็ตามเนื่องจากที่มีของช่องโหว่นี้นั้นมาจากการ &ldquo;หลุด&rdquo; และยังเห็นได้ถึงความพยายามในการปิดข่าวก่อนที่ทางไมโครซอฟต์จะพร้อมปล่อยแพตช์จริงๆ ในช่วงนั้นเราอาจพูดได้ว่าแทบไม่มีใครที่ทราบอย่างแท้จริงถึงรายละเอียดและที่มาของช่องโหว่นั้นนอกเสียจากเป็นบุคคลกลุ่มที่หนึ่งและที่สองซึ่งเกี่ยวข้องกับการป้องกันและลดผลกระทบจากการโจมตีช่องโหว่นี้เองที่ควรจะทราบข้อมูลดีที่สุด</p>
<p>ด้วยเหตุนี้เราอาจถือได้ว่าผลผลิตใดๆ ที่เกิดในช่วงเวลาที่ข้อมูลยังไม่ชัดเจนนั้นสามารถที่จะสร้างผลลัพธ์ที่ไม่ชัดเจนได้ตามข้อมูลที่มันนำมาประเมิน และนี่คือประเด็นหลักที่เราจะพูดถึงกันในบล็อกนี้ครับ</p>
<h2 id="การเกดขนของสครปต-scanner">การเกิดขึ้นของสคริปต์ Scanner</h2>
<p>ในช่วงก่อนมีการออกแพตช์และเปิดเผยรายละเอียดของช่องโหว่อย่างชัดเจน มีการปรากฎของสคริปต์ที่อ้างว่าสามารถยืนยันการมีอยู่ของช่องโหว่ได้เป็นจำนวนมาก บางส่วนที่เราพบมีตามรายการดังนี้</p>
<ul>
<li>สคริปต์จาก <a href="https://github.com/ollypwn/SMBGhost">ollypwn/SMBGHost</a></li>
<li>สคริปต์จาก <a href="https://github.com/xax007/CVE-2020-0796-Scanner">xax007/CVE-2020-0796-Scanner</a></li>
</ul>
<p>เมื่อเราใช้สคริปต์ในการตรวจหาการมีอยู่ของช่องโหว่ในมุมของผู้ใช้งาน เราคาดหวังว่าผลลัพธ์ของสคริปต์จะต้องสามารถบอกได้ว่าระบบที่เราตรวจสอบนั้นมีช่องโหว่ (Vulnerable) หรือไม่มีช่องโหว่ (Not Vulnerable) และที่สำคัญกว่านั้นความน่าเชื่อถือของผลลัพธ์ที่มาจากการใช้สคริปต์เหล่านี้ซึ่งจะส่งผลต้องกระบวนการ Vulnerability management อย่างชัดเจน ดังนั้นการจะยืนยันความน่าเชื่อถือของผลลัพธ์จากสคริปต์เหล่านี้ได้นั้นคือเข้าใจวิธีการในการตรวจหาและเงื่อนไขที่ทำให้สคริปต์ระบุว่าระบบนั้นๆ มีช่องโหว่</p>
<h2 id="เงอนไขของ-ollypwnsmbghost-ในการระบหาชองโหว">เงื่อนไขของ ollypwn/SMBGhost ในการระบุหาช่องโหว่</h2>
<p>สำหรับสคริปต์ ollypwn/SMBGhost นั้น มันถูกพัฒนาขึ้นมาจากการทำงานของโปรโตคอลจริงๆ ตามที่ปรากฎไว้ในไฟล์ <a href="https://github.com/ollypwn/SMBGhost/blob/master/SMBGhost.pcap">SmbGhost.pcap</a> ตามรูปภาพด้านล่าง</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pkt <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\xc0\xfe</span><span style="color:#e6db74">SMB@</span><span style="color:#ae81ff">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#e6db74">x</span><span style="color:#ae81ff">\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00</span><span style="color:#e6db74">&amp;</span><span style="color:#ae81ff">\x00\x00\x00\x00\x00\x01\x00</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>

subnet <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]

<span style="color:#66d9ef">for</span> ip <span style="color:#f92672">in</span> IPNetwork(subnet):

    sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET)
    sock<span style="color:#f92672">.</span>settimeout(<span style="color:#ae81ff">3</span>)

    <span style="color:#66d9ef">try</span>:
        sock<span style="color:#f92672">.</span>connect(( str(ip),  <span style="color:#ae81ff">445</span> ))
    <span style="color:#66d9ef">except</span>:
        sock<span style="color:#f92672">.</span>close()
        <span style="color:#66d9ef">continue</span>

    sock<span style="color:#f92672">.</span>send(pkt)

    nb, <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#34;&gt;I&#34;</span>, sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">4</span>))
    res <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(nb)

    <span style="color:#66d9ef">if</span> res[<span style="color:#ae81ff">68</span>:<span style="color:#ae81ff">70</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x03</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">or</span> res[<span style="color:#ae81ff">70</span>:<span style="color:#ae81ff">72</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x02\x00</span><span style="color:#e6db74">&#34;</span>:
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{ip} Not vulnerable.&#34;</span>)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{ip} Vulnerable&#34;</span>)
</code></pre></div><p>จากโค้ดด้านบน เราสามารถอธิบายขั้นตอนการตรวจสอบการมีอยู่ของช่องโหว่โดยสคริปต์จาก ollypwn/SMBGhost ได้ตามขั้นตอนดังต่อไปนี้</p>
<ol>
<li>เชื่อมไปต่อไปยังพอร์ต 445 ของหมายเลขไอพีแอดเดรสที่ระบุ</li>
<li>ทำการส่งข้อมูลที่ถูกเก็บในตัวแปร <code>pkt</code> ไป โดยข้อมูลที่ถูกเก็บอยู่ในตัวแปร <code>pkt</code> คือข้อมูลที่ SMB จะส่งเพื่อทำกระบวนการ Negotitate Protocol Request</li>
<li>เมื่อปลายทางได้รับ Negotitate Protocol Request มันจะทำการส่ง Negotitate Protocol Response มา โดยค่านี้จะถูกเก็บไว้ที่ตัวแปร <code>res</code></li>
<li>สคริปต์ทำการตรวจสอบค่าในตัวแปร <code>res</code> ในสองตำแหน่ง ได้แก่
<ol>
<li>ตำแหน่ง <code>0x7e</code> - <code>0x7f</code> ว่ามีค่าเป็น <code>\x11\x03</code> หรือไม่</li>
<li>ตำแหน่ง <code>0x80</code> - <code>0x81</code> ว่ามีค่าเป็น <code>\x02\x00</code> หรือไม่</li>
</ol>
</li>
<li>ข้อความ Vulnerable จะปรากฎขึ้นมาเมื่อในตำแหน่งดังกล่าวมีค่าทั้งสองค่านี้เท่านั้น</li>
</ol>
<p>เมื่อตรวจสอบเพิ่มเติมในมาตรฐานของโปรโตคอลที่ SMB2 NEGOTIATE Response อ้างอิง (ดูเพิ่มเติม <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/63abf97c-0d09-47e2-88d6-6bfa552949a5">2.2.4 SMB2 NEGOTIATE Response</a>) การตรวจสอบค่าทั้งสองค่ามีความหมายดังนี้</p>
<p><img src="https://1.bp.blogspot.com/--pmB4bT3B1s/XmskfvfxtrI/AAAAAAAAVKw/fyPAKM-ctuoWCVzoz9HBdd9JdgQDllrUQCLcBGAsYHQ/s1600/Annotation%2B2020-03-13%2B131103.png" alt=""></p>
<ul>
<li>ในตำแหน่งที่มีการปรากฎของค่า <code>\x11\x03</code> นั้น คือตำแหน่ง <code>DialectRevision</code> ขนาด 2 ไบต์ ซึ่งใช้ในการระบุหมายเลข Revision ของโปรโตคอล โดยค่า <code>0x0311</code> นั้นเป็นค่า Dialect revision number ของ SMB 3.1.1 ดังนั้นการตรวจสอบค่านี้จะช่วยยืนยันถึงเลข Revision ที่โปรโตคอล SMB ใช้งานอยู่ได้</li>
<li>ในตำแหน่งที่มีการปรากฎของค่า <code>\x02\x00</code> นั้น คือตำแหน่ง <code>NegotiateContextCount</code> ขนาด 2 ไบต์ซึ่งใช้ในการแสดงจำนวน Context ที่มีอยู่ใน <code>NegotitateContextList</code> ในกระบวนการ Negotitate ของโปรโตคอล SMB เราอาจมองได้ว่า Context คือ &ldquo;ฟีเจอร์&rdquo; ของโปรโตคอล อาทิ การบีบอีด, การเข้ารหัสและอื่นๆ โดย &ldquo;ฟีเจอร์&rdquo; เหล่านี้จะถูกเก็บไว้ใน <code>NegotitateContextList</code> และใช้ <code>NegotitateContextCount</code> ในการบอกจำนวน ดังนั้นการตรวจสอบค่านี้จะใช้ในการยืนยันจำนวน &ldquo;ฟีเจอร์&rdquo; ที่จะมีการใช้งานกับโปรโตคอล SMB</li>
</ul>
<p>อ้างอิงจากข่าวหลุดซึ่งระบุไว้ว่าช่องโหว่นั้นเกี่ยวข้องกับกระบวนการ Compression ที่เกิดขึ้นในโปรโตคอล SMB ที่ถูกอิมพลีเมนต์โดยไมโครซอฟต์ เราจะสังเกตเห็นได้ว่า<strong>สคริปต์ ollypwn/SMBGhost ไม่ได้ทำการตรวจสอบฟีเจอร์ของโปรโตคอลใน NegotiateContextList เลย กระบวนการตรวจสอบฟีเจอร์ทำเพียงแค่นับจำนวนฟีเจอร์เท่านั้น ไม่ได้ระบุเข้าไปว่าฟีเจอร์ดังกล่าวคืออะไร</strong></p>
<p><img src="https://1.bp.blogspot.com/-jjZB6uGIXsI/XmslpMnyCBI/AAAAAAAAVK8/UlSb2Qei2loKYFTZEtC5D6BxZkrWw9bIACLcBGAsYHQ/s1600/Annotation%2B2020-03-13%2B131802.png" alt=""></p>
<p>จุดสำคัญอีกจุดหนึ่งคือถึงแม้สคริปต์จะทำการตรวจสอบฟีเจอร์ใน <code>NegotitateContextList</code> ว่ามีฟีเจอร์ชื่อ <code>SMB2_COMPRESSION_CAPABILITIES</code> หรือไม่ สคริปต์จะต้องทำการตรวจสอบด้วยว่าค่าใน offset ของ <code>CompressionAlgorithms</code> เป็นค่าใด เพราะหากค่าใน offset ดังกล่าวคือ <code>0x0000</code> แล้ว กระบวนการ Compression จะไม่มีทางเกิดขึ้นเลย</p>
<h2 id="เงอนไขของ-xax007cve-2020-0796-scanner-ในการระบหาชองโหว">เงื่อนไขของ xax007/CVE-2020-0796-Scanner ในการระบุหาช่องโหว่</h2>
<p>เมื่อเรามาดูสคริปต์จากโครงการ xax007/CVE-2020-0796-Scanner ซึ่งระบุว่าได้รับแรงบันดาลใจมาจากสคริปต์ ollypwn/SMBGhost เราจะพบข้อแตกต่างที่เห็นอย่างชัดเจนตามซอร์สโค้ดด้านล่าง</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">try</span>:
    sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET)
    sock<span style="color:#f92672">.</span>settimeout(<span style="color:#ae81ff">3</span>)
    sock<span style="color:#f92672">.</span>connect(( sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>],  <span style="color:#ae81ff">445</span> ))
    sock<span style="color:#f92672">.</span>send(payload)
    response <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">2020</span>)
    sock<span style="color:#f92672">.</span>close()
    <span style="color:#75715e"># Detect support SMB version </span>
    <span style="color:#75715e"># 1103 -&gt; 3.1.1</span>
    <span style="color:#66d9ef">if</span> binascii<span style="color:#f92672">.</span>hexlify(response)[<span style="color:#ae81ff">144</span>:<span style="color:#ae81ff">148</span>]<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;1103&#39;</span>): 
        <span style="color:#66d9ef">print</span>(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; support SMB protocol version 3.1.1&#34;</span>)
    <span style="color:#75715e"># See above Value:Meaning comment</span>
    <span style="color:#66d9ef">if</span> binascii<span style="color:#f92672">.</span>hexlify(response)[<span style="color:#f92672">-</span><span style="color:#ae81ff">36</span>:]<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;03&#39;</span>):
        <span style="color:#66d9ef">if</span> response[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:] <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x01\x00</span><span style="color:#e6db74">&#39;</span>:
            exit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Vulnerable!!!</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Target support LZNT1 compression algorithm&#34;</span>)
        <span style="color:#66d9ef">if</span> response[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:] <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x02\x00</span><span style="color:#e6db74">&#39;</span>:
            exit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Vulnerable!!!</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Target support LZ77 compression algorithm&#34;</span>)
        <span style="color:#66d9ef">if</span> response[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:] <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x03\x00</span><span style="color:#e6db74">&#39;</span>:
            exit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Vulnerable!!!</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Target support LZ77+Huffman compression algorithm&#34;</span>)
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> identifier:
    exit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> str(identifier))
</code></pre></div><p>โค้ดสำหรับการตรวจสอบช่องโหว่ของ xax007/CVE-2020-0796-Scanner แยกเงื่อนไขออกเป็นสองส่วนเช่นเดียวกัน คือส่วนที่มีการตรวจสอบ <code>DialectRevision</code> ว่าใช่ค่า <code>0x0311</code> หรือไม่ อย่างไรก็ตามในส่วนที่สองนั้น สคริปต์ไม่ได้ตรวจสอบ <code>NegotiateContextCount</code> แต่ข้ามไปตรวจสอบค่าใน <code>NegotiateContextList</code> ทันทีว่าสามารถระบุหาการใช้ <code>CompressionAlgorithms</code> ได้หรือไม่</p>
<p>จากที่เราได้อธิบายไปแล้วในหัวข้อด้านบน สคริปต์นี้จะแสดงผล &ldquo;Not vulnerable&rdquo; ก็ต่อเมื่อค่าใน <code>CompressionAlgorithms</code> เป็น <code>0x000</code> ซึ่งหมายถึงว่าไม่มีการ <code>Compression</code> เกิดขึ้น และจะแสดงผลก็ต่อเมื่อค่าใน <code>CompressionAlgorithms</code> เป็นค่าใดค่าหนึ่งที่เกี่ยวข้องกับอัลกอริธึมในการบีบอัดข้อมูล</p>
<p>แน่นนอนว่าสคริปต์จากโครงการ xax007/CVE-2020-0796-Scanner สามารถระบุได้ดีกว่า ollypwn/SMBGhost ถึงการมีอยู่ของฟีเจอร์ชื่อ <code>SMB2_COMPRESSION_CAPABILITIES</code> และค่าในฟีเจอร์ดังกล่าว แต่ปัญหาอีกปัญหาหนึ่งที่ยังคงถูกซ่อนอยู่คือประเด็นสำคัญว่า หากการแก้ไขช่องโหว่นั้นไม่เกี่ยวข้องหรือทำให้เกิดการเปลี่ยนแปลงในกระบวนการ Negotitate ของโปรโตคอล SMB แล้ว สคริปต์จากโครง xax007/CVE-2020-0796 จะไม่สามารถแยกระบบที่ถูกแพตช์แล้วออกจากระบบที่ยังไม่ถูกแพตช์ได้ เพราะทุกระบบจะยังคงมีหน้าตาของการ Negotitate เหมือนเดิม</p>
<p>การที่จะยืนยันประเด็นนี้ได้สามารถทำได้เพียงวิธีการเดียวคือทำเข้าใจแพตช์และเงื่อนไขในการโจมตีช่องโหว่เท่านั้น</p>
<h2 id="วเคราะหแพตช-cve-2020-0796">วิเคราะห์แพตช์ CVE-2020-0796</h2>
<p>โดยปกติการอิมพลีเมนต์การใช้งานโปรโตคอล SMB ในระบบปฏิบัติการ Windows จะอยู่ในไฟล์ไดรเวอร์ื่อ <code>srv2.sys</code> ที่ตำแหน่ง <code>C:\Windows\System32\drivers\srv2.sys</code> ดังนั้นเราจะต้องหาไฟล์จากระบบที่สอดคล้องกับเงื่อนไขของช่องโหว่ทั้งที่ยังแพตช์และยังไม่ได้มีการแพตช์มาเปรียบเทียบหาข้อแตกต่างกัน ในเบื้องต้นเราสามารถยืนยันไฟล์ <code>srv2.sys</code> ทั้งสองลักษณะตามค่าแฮชได้ดังนี้</p>
<ul>
<li>ค่า MD5 ของ srv2.sys ก่อนถูกแพตช์ f508ec2bfc244442d76091cb03bae110</li>
<li>ค่า MD5 ของ srv2.sys หลังถูกแพตช์ f037de85645d30a21cd79cb1f8bb706a</li>
</ul>
<p>หากจะทำการวิเคราะห์แพตช์ตาม ลองตรวจสอบค่าแฮชของไฟล์ <code>srv2.sys</code> ทั้งสองไฟล์ว่าตรงกับที่ระบุไว้หรือไม่ดูครับ ส่วนเครื่องมือในการวิเคราะห์และเปรียบเทียบความแตกต่าง อ่านเพิ่มเติมได้ที่โพสต์ขั้นตอนการติดตั้ง BinExport กับ Ghidra เพื่อเปรียบเทียบความแตกต่างของไบนารีด้วย BinDiff 6</p>
<p>อ้างอิงจากบทความการวิเคราะห์ช่องโหว่โดย Synacktiv และผลจากการหาความแตกต่างของไฟล์ srv2.sys ทั้งสองเวอร์ชัน เราจะพบสิ่งที่ตรงกันคือฟังก์ชัน <code>Srv2DecompressData</code>เป็นฟังก์ชันที่พบการเปลี่ยนแปลงมากที่สุดเมื่อเทียบกับฟังก์ชันอื่นๆ</p>
<p><img src="https://1.bp.blogspot.com/-rsD_7iySfTE/XmsquOnm9TI/AAAAAAAAVLU/Fd0rBMWxDDMNP5t7YmPEbdCohP8Sa_KRgCLcBGAsYHQ/s640/ES7ukepU4AEqbP3.png" alt=""></p>
<p>ผลลัพธ์จากการดีคอมไพล์ฟังก์ชันดังกล่าวจากไฟล์ <code>srv2.sys</code> ทั้งสองเวอร์ชันแสดงให้เห็นถึงโค้ดของแพตช์ที่ถูกเพิ่มเข้ามาก่อนจะถึงโค้ดที่มีช่องโหว่ รูปภาพด้านล่างแสดงให้เห็นถึงโค้ดของฟังก์ชันที่มีช่องโหว่ในจุดที่ <code>SrvNetAllocateBuffer</code> สามารถถูกทำ integer overflow ด้วยการเปลี่ยนแปลงค่า <code>OriginalCompressedSegmentSize</code> และ <code>OffsetOrLength</code> โดยมี flow การทำงานคือมีการเปรียบเทียบ <code>CompressAlgorithm</code> ก่อน จากนั้นจึงเรียกใช้ฟังก์ชัน <code>SrvNetAllocateBuffer</code> และเริ่มการคลายการบีบอัดด้วย <code>SmbCompressionDecompress</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (allocated_buffer <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000009a</span>;
}
iVar6 <span style="color:#f92672">=</span> SmbCompressionDecompress
                  ((ulonglong)uVar2,
                  (ulonglong)PayloadSize <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">+</span>
                  <span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(smb_packet <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),
                  (ulonglong)
                  ((<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(smb_packet <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>) <span style="color:#f92672">-</span> PayloadSize) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>),
                  <span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(allocated_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">+</span> (ulonglong)PayloadSize,iVar9,Header,
                  uVar8,uVar10);
<span style="color:#66d9ef">if</span> ((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> iVar6) <span style="color:#f92672">&amp;&amp;</span> (Header[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> iVar9)) {
<span style="color:#66d9ef">if</span> (PayloadSize <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
   memcpy(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(allocated_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),
         (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(smb_packet <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),
         (ulonglong)PayloadSize);
}
<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(allocated_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>) <span style="color:#f92672">=</span> Header[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> PayloadSize;
Srv2ReplaceReceiveBuffer(smb_packet,allocated_buffer);
<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
SrvNetFreeBuffer(allocated_buffer)
</code></pre></div><p>สำหรับโค้ดที่ถูกเพิ่มขึ้นมาใหม่ในไฟล์ไดรเวอร์ <code>srv2.sys</code> นั้น เป็นการใช้ฟังก์ชัน <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntintsafe/nf-ntintsafe-rtlulongadd">RtlULongAdd</a> เพื่อช่วยตรวจสอบหากเกิดกรณีของ Integer overflow โดยฟังก์ชัน <code>RtlULongAdd</code> จะให้ผลลัพธ์ <code>STATUS_INTEGER_OVERFLOW</code> ทันทีเมื่อตรวจพบ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0xf</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>)) {
   puVar3 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">**</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>);
   uVar2 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(lVar7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8c</span>);
                  <span style="color:#75715e">/* WARNING: Load size is inaccurate */</span>
   auVar4 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)puVar3;
   uVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(puVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xc</span>);
   uVar13 <span style="color:#f92672">=</span> SUB124(auVar4,<span style="color:#ae81ff">0</span>);
   uVar14 <span style="color:#f92672">=</span> SUB124(auVar4 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0</span>);
   uVar15 <span style="color:#f92672">=</span> SUB124(auVar4 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0</span>);
   <span style="color:#66d9ef">if</span> (uVar2 <span style="color:#f92672">!=</span> (SUB164(<span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)puVar3 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffff</span>)) {
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc00000bb</span>;
   }
   uVar6 <span style="color:#f92672">=</span> RtlULongAdd(uVar14,SUB164(<span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)puVar3 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0x60</span>,<span style="color:#ae81ff">0</span>),local_res10);
   uVar16 <span style="color:#f92672">=</span> (undefined)uVar1;
   <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)uVar6 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
   <span style="color:#66d9ef">if</span> ((undefined <span style="color:#f92672">**</span>)WPP_GLOBAL_Control <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>WPP_GLOBAL_Control) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(WPP_GLOBAL_Control <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2c</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   <span style="color:#66d9ef">if</span> (WPP_GLOBAL_Control[<span style="color:#ae81ff">0x29</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\0&#39;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   WPP_SF_LL((<span style="color:#66d9ef">char</span>)<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(WPP_GLOBAL_Control <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">0x98</span>,(<span style="color:#66d9ef">char</span>)uVar14,uVar16);
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   <span style="color:#66d9ef">if</span> ((ulonglong)(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(lVar7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x100</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x34</span> <span style="color:#f92672">&lt;</span> (ulonglong)local_res10[<span style="color:#ae81ff">0</span>]) {
   <span style="color:#66d9ef">if</span> ((undefined <span style="color:#f92672">**</span>)WPP_GLOBAL_Control <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>WPP_GLOBAL_Control) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(WPP_GLOBAL_Control <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2c</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   <span style="color:#66d9ef">if</span> (WPP_GLOBAL_Control[<span style="color:#ae81ff">0x29</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\0&#39;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   WPP_SF_L();
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000090b</span>;
   }
   lVar7 <span style="color:#f92672">=</span> SrvNetAllocateBuffer();
   <span style="color:#66d9ef">if</span> (lVar7 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0xc000009a</span>;
   }
   lVar12 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>);
   uVar10 <span style="color:#f92672">=</span> SUB81(local_res10,<span style="color:#ae81ff">0</span>);
   uVar9 <span style="color:#f92672">=</span> (ulonglong)uVar1;
   uVar11 <span style="color:#f92672">=</span> (undefined)<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(lVar12 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>);
   local_res10[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(lVar12 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>;
   uVar8 <span style="color:#f92672">=</span> uVar16;
   uVar6 <span style="color:#f92672">=</span> RtlULongSub(local_res10[<span style="color:#ae81ff">0</span>],uVar1,(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)local_res10);
   <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">int</span>)uVar6 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
   <span style="color:#66d9ef">if</span> ((((undefined <span style="color:#f92672">**</span>)WPP_GLOBAL_Control <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>WPP_GLOBAL_Control) <span style="color:#f92672">&amp;&amp;</span>
         ((<span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)(WPP_GLOBAL_Control <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2c</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&amp;&amp;</span> (WPP_GLOBAL_Control[<span style="color:#ae81ff">0x29</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>))
   {
      WPP_SF_LLL((<span style="color:#66d9ef">char</span>)<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(WPP_GLOBAL_Control <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),uVar8,uVar10,uVar11,
                  in_stack_ffffffffffffffb8,uVar16);
   }
   }
   <span style="color:#66d9ef">else</span> {
   iVar5 <span style="color:#f92672">=</span> SmbCompressionDecompress
                     ((ulonglong)uVar2,uVar9 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(lVar12 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),
                        (ulonglong)local_res10[<span style="color:#ae81ff">0</span>],<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(lVar7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">+</span> uVar9,uVar14,
                        local_res8,uVar13,uVar15);
   <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> iVar5) <span style="color:#f92672">&amp;&amp;</span> (local_res8[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> uVar14)) {
      <span style="color:#66d9ef">if</span> (uVar1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
         memcpy(<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">**</span>)(lVar7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>),
               (undefined8 <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(longlong <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),uVar9);
      }
      <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(lVar7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x24</span>) <span style="color:#f92672">=</span> local_res8[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> uVar1;
      Srv2ReplaceReceiveBuffer(param_1,lVar7);
      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
   }
   }
   SrvNetFreeBuffer(lVar7);
</code></pre></div><p>เราจะสามารถเห็นจากแพตช์ได้ว่า เนื่องจากปัญหาการ Overflow เกิดขึ้นที่ฟังก์ชัน <code>SrvNetAllocateBuffer</code> และเกี่ยวข้องกับค่า <code>OriginalCompressedSegmentSize</code> และ <code>OffsetOrLength</code> และโค้ดของแพตช์ที่เพิ่มเข้ามานั้นไม่มีจุดที่แก้ในกระบวนการตรวจสอบ <code>CompressionAlgorithms</code> เลย เงื่อนไขเดียวที่เกี่ยวข้องกับ <code>CompressionAlgorithms</code> นั้นคือค่าของ <code>CompressionAlgorithms</code> ใน <code>SMB2_TRANSFORM_HEADER</code> จะต้องตรงกับค่าของ <code>CompressmionAlgorithms</code> ใน Negotitate Protocol Response เท่านั้น</p>
<p><strong>ดังนั้นช่องโหว่นี้จึงไม่มีส่วนเกี่ยวข้องกับอัลกอริธึมที่ใช้ในการบีบอัด และในขณะเดียวกันการตรวจสอบว่าระบบนั้นมีช่องโหว่หรือไม่มีช่องโหว่จึงไม่สามารถทำได้แม้จะทำการตรวจสอบไปถึงระบบอัลกอริมธึมการบีบอีดใน <code>SMB2_COMPRESSION_CAPABILITIES</code></strong></p>
<h2 id="ทางเลอกในการตรวจสอบชองโหว">ทางเลือกในการตรวจสอบช่องโหว่</h2>
<p>ในมุมของผู้ดูแลระบบนั้น ทางเลือกในการตรวจสอบช่องโหว่ที่มีประสิทธิภาพที่สุดคือการระบุหารุ่นของระบบปฏิบัติการที่ได้รับผลกระทบและตรวจสอบ KB ที่ระบบติดตั้งอยู่ว่ามี KB4551762 หรือไม่</p>
<p>สำหรับในมุมของผู้โจมตี อาจแทบเป็นไปได้ที่จะยืนยันได้ว่าระบบที่จะโจมตีนั้นมีช่องโหว่ CVE-2020-0796 อยู่จริงแน่นอนหากต้องเริ่มต้นจากการไม่มีข้อมูลใดๆ เลย เพราะการยืนยันด้วย Active information gathering ก็ไม่สามาถระบุได้ว่าระบบดังกล่าวถูกแพตช์แล้วหรือยัง ดังนั้นวิธีการที่อาจยอมรับได้คือการระบุหาข้อมูลของระบบใดระบบหนึ่งที่เข้ายึดครองได้มาก่อนในเครือข่ายเป้าหมาาย และตรวจสอบความเป็นไปได้จากปัจจัยอื่นๆ ภายในองค์กร อาทิ ความกระตือรือล้นในการติดตั้งแพตช์และรับข้อมูลข่าวสารด้านภัยคุกคาม ปริมาณงานซึ่งอาจทำให้พนักงานภายในองค์กรไม่มีเวลามาทำการติดตั้งแพตช์ เป็นต้น ทั้งนี้การใช้ช่องโหว่ที่เป็นที่รู้จักอย่างช่องโหว่นี้ก็อาจสร้างความเสี่ยงที่จะส่งผลให้ปฏิบัติการถูกเปิดโปงได้เช่นเดียวกัน</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://pandora.sh/posts/code-note-0x1-deathransom/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Code Note 0x1: DeathRansom</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://pandora.sh/posts/config-binexport-with-ghidra/">
                  <span class="button__text">Integrating BinExport with GhiDra</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">P. Boonyakarn © 2018 - 2021 CC-BY</div>
      
  </div>
</footer>

<script src="https://pandora.sh/assets/main.js"></script>
<script src="https://pandora.sh/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
